{% extends "layout.html" %}

{% block title %}Settings - MyLabVault{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-12">
        <h1 class="m-0">
          <i class="mdi mdi-cog mr-2"></i>
          Application Settings
        </h1>
      </div>
    </div>
  </div>
</div>

<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    
    <!-- User Interface Settings -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="mdi mdi-palette mr-2"></i>
              User Interface
            </h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="darkModeToggle">Theme Preference</label>
              <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="darkModeToggle" {{ 'checked' if user_settings.dark_mode }}>
                <label class="custom-control-label" for="darkModeToggle">
                  <i class="mdi mdi-moon-waxing-crescent mr-1"></i>
                  Dark Mode
                </label>
              </div>
              <small class="form-text text-muted">Toggle between light and dark theme</small>
            </div>
            
            <div class="form-group">
              <label for="dateFormatSelect">
                <i class="mdi mdi-calendar mr-1"></i>
                Date Display Format
              </label>
              <select class="form-control" id="dateFormatSelect">
                <option value="MM/DD/YYYY" {{ 'selected' if user_settings.date_format == 'MM/DD/YYYY' or not user_settings.date_format }}></option>
                <option value="DD/MM/YYYY" {{ 'selected' if user_settings.date_format == 'DD/MM/YYYY' }}></option>
                <option value="YYYY-MM-DD" {{ 'selected' if user_settings.date_format == 'YYYY-MM-DD' }}></option>
                <option value="MM-DD-YYYY" {{ 'selected' if user_settings.date_format == 'MM-DD-YYYY' }}></option>
                <option value="DD-MM-YYYY" {{ 'selected' if user_settings.date_format == 'DD-MM-YYYY' }}></option>
                <option value="DD-MMM-YYYY" {{ 'selected' if user_settings.date_format == 'DD-MMM-YYYY' }}></option>
                <option value="YYYY-MMM-DD" {{ 'selected' if user_settings.date_format == 'YYYY-MMM-DD' }}></option>
              </select>
              <small class="form-text text-muted">Choose how dates are displayed throughout the application</small>
              <div class="mt-2">
                <small class="text-info">
                  <i class="mdi mdi-information mr-1"></i>
                  Preview: <span id="dateFormatPreview">Loading...</span>
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="mdi mdi-information mr-2"></i>
              System Information
            </h3>
          </div>
          <div class="card-body">
            <div id="systemInfo">
              <!-- System info will be loaded dynamically -->
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2">Loading system information...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Export & Import Section -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="mdi mdi-download mr-2"></i>
              Data Export
            </h3>
          </div>
          <div class="card-body">
            <p class="text-muted">Export your lab data for backup, analysis, or migration purposes.</p>
            
            <form id="exportForm">
              <div class="form-group">
                <label for="patientSelection">
                  <i class="mdi mdi-account-multiple mr-1"></i>
                  Patient Selection
                </label>
                <select class="form-control" id="patientSelection">
                  <option value="all">All Patients</option>
                  <option value="select">Select Specific Patients...</option>
                </select>
              </div>
              
              <div class="form-group" id="specificPatientsGroup" style="display: none;">
                <label for="specificPatients">Select Patients</label>
                <select class="form-control" id="specificPatients" multiple size="3">
                  <!-- Patients will be loaded dynamically -->
                </select>
                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
              </div>
              
              <div class="form-group">
                <label for="dateRangeSelection">
                  <i class="mdi mdi-calendar mr-1"></i>
                  Date Range
                </label>
                <select class="form-control" id="dateRangeSelection">
                  <option value="all">All Time</option>
                  <option value="last-year">Last Year</option>
                  <option value="last-6-months">Last 6 Months</option>
                  <option value="last-3-months">Last 3 Months</option>
                  <option value="custom">Custom Range...</option>
                </select>
              </div>
              
              <div class="row" id="customDateRange" style="display: none;">
                <div class="col-6">
                  <div class="form-group">
                    <label for="startDate">From</label>
                    <input type="date" class="form-control" id="startDate">
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-group">
                    <label for="endDate">To</label>
                    <input type="date" class="form-control" id="endDate">
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="includePdfs" checked>
                  <label class="custom-control-label" for="includePdfs">
                    <i class="mdi mdi-file-pdf mr-1"></i>
                    Include PDF Files
                  </label>
                </div>
                <small class="form-text text-muted">Creates a ZIP archive with data and PDF files</small>
              </div>
              
              <div class="alert alert-info">
                <i class="mdi mdi-information mr-2"></i>
                <strong>Export Preview:</strong>
                <div id="exportPreview">
                  <span class="text-muted">Configure options above to see preview</span>
                </div>
              </div>
              
              <div class="text-center">
                <button type="button" class="btn btn-outline-info mr-2" id="previewBtn">
                  <i class="mdi mdi-eye mr-1"></i>
                  Preview
                </button>
                <button type="submit" class="btn btn-success" id="exportBtn" disabled>
                  <i class="mdi mdi-download mr-1"></i>
                  Export Data
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="mdi mdi-upload mr-2"></i>
              Data Import
            </h3>
          </div>
          <div class="card-body">
            <p class="text-muted">Import previously exported MyLabVault data including JSON data and PDF files.</p>
            
            <form id="importForm" enctype="multipart/form-data">
              <div class="form-group">
                <label for="importFile">
                  <i class="mdi mdi-file-import mr-1"></i>
                  Select Import File
                </label>
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="importFile" name="import_file" 
                         accept=".json,.zip" required>
                  <label class="custom-file-label" for="importFile">Choose file...</label>
                </div>
                <small class="form-text text-muted">
                  Upload a JSON file (data only) or ZIP file (data + PDFs) from a previous export
                </small>
              </div>
              
              <div class="form-group">
                <label for="importOptions">
                  <i class="mdi mdi-cog mr-1"></i>
                  Import Options
                </label>
                
                <div class="form-group mb-3">
                  <label class="form-label">Import Mode:</label>
                  <div class="custom-control custom-radio">
                    <input type="radio" class="custom-control-input" id="importModeMerge" name="importMode" value="merge" checked>
                    <label class="custom-control-label" for="importModeMerge">
                      <i class="mdi mdi-merge mr-1"></i>
                      <strong>Merge with existing data</strong>
                    </label>
                  </div>
                  <small class="form-text text-muted ml-4">Add imported data to existing records</small>
                  
                  <div class="custom-control custom-radio mt-2">
                    <input type="radio" class="custom-control-input" id="importModeReplace" name="importMode" value="replace">
                    <label class="custom-control-label" for="importModeReplace">
                      <i class="mdi mdi-database-remove mr-1"></i>
                      <strong>Start from scratch</strong>
                      <span class="badge badge-warning ml-2">Destructive</span>
                    </label>
                  </div>
                  <small class="form-text text-muted ml-4">
                    <i class="mdi mdi-alert-triangle mr-1 text-warning"></i>
                    Clear all existing data and replace with imported data only
                  </small>
                </div>
                
                <div class="custom-control custom-checkbox mt-3">
                  <input type="checkbox" class="custom-control-input" id="validateData" checked>
                  <label class="custom-control-label" for="validateData">
                    <i class="mdi mdi-shield-check mr-1"></i>
                    Validate data integrity
                  </label>
                </div>
                <small class="form-text text-muted">Verify data format and consistency before importing</small>
              </div>
              
              <div class="alert alert-info" id="importPreview" style="display: none;">
                <i class="mdi mdi-information mr-2"></i>
                <strong>Import Preview:</strong>
                <div id="importPreviewContent">
                  <span class="text-muted">Upload a file to see import preview</span>
                </div>
              </div>
              
              <div class="alert alert-warning" style="display: none;" id="importWarning">
                <i class="mdi mdi-alert-triangle mr-2"></i>
                <strong>Warning:</strong> This will modify your existing data. Please ensure you have a backup before proceeding.
              </div>
              
              <div class="text-center">
                <button type="button" class="btn btn-outline-info mr-2" id="previewImportBtn" disabled>
                  <i class="mdi mdi-eye mr-1"></i>
                  Preview Import
                </button>
                <button type="submit" class="btn btn-primary" id="importBtn" disabled>
                  <i class="mdi mdi-upload mr-1"></i>
                  Import Data
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Management Section -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="mdi mdi-database-remove mr-2"></i>
              Data Management
            </h3>
          </div>
          <div class="card-body">
            <div class="alert alert-warning">
              <i class="mdi mdi-alert-triangle mr-2"></i>
              <strong>Warning:</strong> The actions below are destructive and cannot be undone. Use with extreme caution!
            </div>
            
            <div class="row">
              <div class="col-md-8">
                <h5>Reset All Data</h5>
                <p class="text-muted">This will permanently delete:</p>
                <ul class="text-muted">
                  <li>All lab results and test data</li>
                  <li>All imported PDF files</li>
                  <li>All providers, panels, and units</li>
                  <li>All user settings (except this page will reload with defaults)</li>
                </ul>
                <p><strong class="text-danger">This action cannot be undone!</strong></p>
              </div>
              <div class="col-md-4 text-right">
                <button type="button" class="btn btn-danger btn-lg" id="resetDataBtn" onclick="showResetConfirmation()">
                  <i class="mdi mdi-delete-forever mr-2"></i>
                  Reset All Data
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="resetConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="resetConfirmationModalLabel">
          <i class="mdi mdi-alert-octagon mr-2"></i>
          Confirm Data Reset
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="mdi mdi-alert-triangle mr-2"></i>
          <strong>DANGER:</strong> You are about to permanently delete all data in MyLabVault!
        </div>
        
        <h6><strong>This will delete:</strong></h6>
        <div class="row">
          <div class="col-md-6">
            <ul class="list-unstyled">
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="labResultsCount">0</span> Lab Results</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="labsCount">0</span> Lab Tests</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="panelsCount">0</span> Panels</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="unitsCount">0</span> Units</li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="list-unstyled">
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="providersCount">0</span> Providers</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="pdfImportsCount">0</span> PDF Imports</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> <span id="pdfFilesCount">0</span> PDF Files</li>
              <li><i class="mdi mdi-close-circle text-danger mr-1"></i> All User Settings</li>
            </ul>
          </div>
        </div>
        
        <div class="alert alert-info mt-3">
          <i class="mdi mdi-information mr-2"></i>
          <strong>Total Items to Delete:</strong> <span id="totalItemsCount">0</span>
        </div>
        
        <p><strong class="text-danger">This action cannot be undone. Are you absolutely sure you want to proceed?</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="mdi mdi-close mr-1"></i>
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn" onclick="executeDataReset()">
          <i class="mdi mdi-delete-forever mr-1"></i>
          <span id="resetBtnText">Reset All Data</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Start from Scratch Import Confirmation Modal -->
<div class="modal fade" id="startFromScratchModal" tabindex="-1" role="dialog" aria-labelledby="startFromScratchModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="startFromScratchModalLabel">
          <i class="mdi mdi-alert-triangle mr-2"></i>
          Start from Scratch - Confirm Destructive Operation
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="mdi mdi-alert-circle mr-2"></i>
          <strong>WARNING:</strong> This operation cannot be undone!
        </div>
        
        <p><strong>This will permanently delete ALL existing data including:</strong></p>
        <ul class="list-unstyled ml-3">
          <li><i class="mdi mdi-account-multiple text-danger mr-2"></i>All patients</li>
          <li><i class="mdi mdi-flask text-danger mr-2"></i>All lab results</li>
          <li><i class="mdi mdi-hospital-building text-danger mr-2"></i>All providers</li>
          <li><i class="mdi mdi-test-tube text-danger mr-2"></i>All lab tests and panels</li>
          <li><i class="mdi mdi-file-pdf-box text-danger mr-2"></i>All PDF files</li>
        </ul>
        
        <p class="mt-3"><strong>The imported data will replace everything:</strong></p>
        <div id="replacePreviewContent" class="bg-light p-3 rounded">
          <span class="text-muted">Preview will appear here...</span>
        </div>
        
        <div class="form-group mt-3">
          <label for="confirmText">Type <code>START FROM SCRATCH</code> to confirm:</label>
          <input type="text" class="form-control" id="confirmText" placeholder="Enter confirmation text">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="mdi mdi-close mr-1"></i>
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmStartFromScratchBtn" disabled onclick="executeStartFromScratchImport()">
          <i class="mdi mdi-database-remove mr-1"></i>
          <span id="startFromScratchBtnText">Start from Scratch</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Load system information on page load
    loadSystemInfo();
    
    // Populate dropdown options with previews
    populateDropdownPreviews();
    
    // Initialize date format preview
    updateDateFormatPreview();
    
    // Initialize export functionality
    initializeExportFeature();
    
    // Date format selection handler
    $('#dateFormatSelect').on('change', function() {
        const format = $(this).val();
        updateDateFormatPreview();
        
        // Save the setting
        $.ajax({
            url: '/api/settings/user',
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ date_format: format }),
            success: function(response) {
                // Clear the cached date format so it gets refreshed
                if (typeof clearDateFormatCache === 'function') {
                    clearDateFormatCache();
                }
                
                // Show success message
                const alert = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="mdi mdi-check mr-2"></i>
                        Date format updated successfully.
                        <button type="button" class="close" data-dismiss="alert">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                $('.content-header .container-fluid').after(alert);
                setTimeout(() => $('.alert').fadeOut(), 3000);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.detail || 'Failed to update date format';
                alert('Error: ' + error);
            }
        });
    });
    
    // Dark mode toggle
    $('#darkModeToggle').on('change', function() {
        const isEnabled = $(this).is(':checked');
        
        $.ajax({
            url: '/api/settings/user',
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ dark_mode: isEnabled }),
            success: function(response) {
                // Show success message
                const alert = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="mdi mdi-check mr-2"></i>
                        Theme updated successfully. Refreshing page...
                        <button type="button" class="close" data-dismiss="alert">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `;
                $('.content-header .container-fluid').after(alert);
                
                // Refresh page to apply theme changes
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.detail || 'Failed to update theme';
                alert('Error: ' + error);
                // Reset toggle on error
                $('#darkModeToggle').prop('checked', !isEnabled);
            }
        });
    });
    
});

function loadSystemInfo() {
    $.get('/api/settings/data-counts', function(response) {
        if (response.success) {
            const data = response.data;
            const total = response.total_items;
            
            const systemInfoHtml = `
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Lab Results:</small><br>
                        <strong>${data.lab_results.toLocaleString()}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Lab Tests:</small><br>
                        <strong>${data.labs.toLocaleString()}</strong>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Panels:</small><br>
                        <strong>${data.panels.toLocaleString()}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Units:</small><br>
                        <strong>${data.units.toLocaleString()}</strong>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Providers:</small><br>
                        <strong>${data.providers.toLocaleString()}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">PDF Imports:</small><br>
                        <strong>${data.pdf_imports.toLocaleString()}</strong>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-center">
                        <small class="text-muted">PDF Files:</small><br>
                        <strong>${data.pdf_files.toLocaleString()}</strong>
                    </div>
                </div>
                <hr class="my-3">
                <div class="text-center">
                    <small class="text-muted">Total Items in System:</small><br>
                    <h4 class="text-primary">${total.toLocaleString()}</h4>
                </div>
            `;
            
            $('#systemInfo').html(systemInfoHtml);
        }
    }).fail(function() {
        $('#systemInfo').html(`
            <div class="alert alert-warning">
                <i class="mdi mdi-alert mr-2"></i>
                Unable to load system information
            </div>
        `);
    });
}

function showResetConfirmation() {
    // Load current data counts before showing modal
    $.get('/api/settings/data-counts', function(response) {
        if (response.success) {
            const data = response.data;
            
            // Update counts in modal
            $('#labResultsCount').text(data.lab_results.toLocaleString());
            $('#labsCount').text(data.labs.toLocaleString());
            $('#panelsCount').text(data.panels.toLocaleString());
            $('#unitsCount').text(data.units.toLocaleString());
            $('#providersCount').text(data.providers.toLocaleString());
            $('#pdfImportsCount').text(data.pdf_imports.toLocaleString());
            $('#pdfFilesCount').text(data.pdf_files.toLocaleString());
            $('#totalItemsCount').text(response.total_items.toLocaleString());
        }
        
        // Reset button state
        $('#resetBtnText').text('Reset All Data');
        
        // Show modal
        $('#resetConfirmationModal').modal('show');
    });
}

function executeDataReset() {    
    // Show loading state
    $('#confirmResetBtn').prop('disabled', true);
    $('#resetBtnText').html('<i class="spinner-border spinner-border-sm mr-2"></i>Resetting Data...');
    
    $.ajax({
        url: '/api/settings/reset-data',
        method: 'POST',
        success: function(response) {
            $('#resetConfirmationModal').modal('hide');
            
            // Show success message
            const alert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-check mr-2"></i>
                    ${response.message} Refreshing page...
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            
            // Refresh page after delay
            setTimeout(() => {
                location.reload();
            }, 2000);
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.detail || 'Failed to reset data';
            alert('Error: ' + error);
            
            // Reset button state
            $('#confirmResetBtn').prop('disabled', false);
            $('#resetBtnText').text('Reset All Data');
        }
    });
}

function updateDateFormatPreview() {
    const format = $('#dateFormatSelect').val();
    const today = new Date();
    
    // Create a sample date formatting based on the selected format
    let preview = '';
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    const year = today.getFullYear();
    
    // Month abbreviations array
    const monthAbbreviations = [
        'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ];
    const monthAbbr = monthAbbreviations[today.getMonth()];
    
    switch(format) {
        case 'MM/DD/YYYY':
            preview = `${month}/${day}/${year}`;
            break;
        case 'DD/MM/YYYY':
            preview = `${day}/${month}/${year}`;
            break;
        case 'YYYY-MM-DD':
            preview = `${year}-${month}-${day}`;
            break;
        case 'MM-DD-YYYY':
            preview = `${month}-${day}-${year}`;
            break;
        case 'DD-MM-YYYY':
            preview = `${day}-${month}-${year}`;
            break;
        case 'DD-MMM-YYYY':
            preview = `${day}-${monthAbbr}-${year}`;
            break;
        case 'YYYY-MMM-DD':
            preview = `${year}-${monthAbbr}-${day}`;
            break;
        default:
            preview = `${month}/${day}/${year}`;
    }
    
    $('#dateFormatPreview').text(preview);
}

function populateDropdownPreviews() {
    const today = new Date();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    const year = today.getFullYear();
    
    // Month abbreviations array
    const monthAbbreviations = [
        'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ];
    const monthAbbr = monthAbbreviations[today.getMonth()];
    
    // Create preview text for each format
    const formats = {
        'MM/DD/YYYY': `${month}/${day}/${year}`,
        'DD/MM/YYYY': `${day}/${month}/${year}`,
        'YYYY-MM-DD': `${year}-${month}-${day}`,
        'MM-DD-YYYY': `${month}-${day}-${year}`,
        'DD-MM-YYYY': `${day}-${month}-${year}`,
        'DD-MMM-YYYY': `${day}-${monthAbbr}-${year}`,
        'YYYY-MMM-DD': `${year}-${monthAbbr}-${day}`
    };
    
    // Update each option with its preview
    $('#dateFormatSelect option').each(function() {
        const format = $(this).val();
        const preview = formats[format];
        if (preview) {
            $(this).text(preview);
        }
    });
}

// Export Feature Functions
function initializeExportFeature() {
    // Load patients for selection
    loadPatientsForExport();
    
    // Set default end date to today
    const today = new Date().toISOString().split('T')[0];
    $('#endDate').val(today);
    
    // Patient selection change handler
    $('#patientSelection').on('change', function() {
        if ($(this).val() === 'select') {
            $('#specificPatientsGroup').show();
        } else {
            $('#specificPatientsGroup').hide();
        }
        updateExportPreview();
    });
    
    // Date range selection change handler
    $('#dateRangeSelection').on('change', function() {
        const selection = $(this).val();
        if (selection === 'custom') {
            $('#customDateRange').show();
        } else {
            $('#customDateRange').hide();
            setPresetDateRange(selection);
        }
        updateExportPreview();
    });
    
    // Custom date change handlers
    $('#startDate, #endDate').on('change', updateExportPreview);
    
    // Include PDFs change handler
    $('#includePdfs').on('change', updateExportPreview);
    
    // Specific patients change handler
    $('#specificPatients').on('change', updateExportPreview);
    
    // Preview button handler
    $('#previewBtn').on('click', function() {
        generateExportPreview();
    });
    
    // Export form submission
    $('#exportForm').on('submit', function(e) {
        e.preventDefault();
        executeExport();
    });
    
    // Initial preview update
    updateExportPreview();
}

function loadPatientsForExport() {
    $.get('/api/patients', function(patients) {
        const patientsSelect = $('#specificPatients');
        patientsSelect.empty();
        
        patients.forEach(patient => {
            patientsSelect.append(`<option value="${patient.id}">${patient.name}</option>`);
        });
    }).fail(function() {
        console.error('Failed to load patients for export');
    });
}

function setPresetDateRange(preset) {
    const today = new Date();
    const endDate = today.toISOString().split('T')[0];
    let startDate = '';
    
    switch (preset) {
        case 'last-year':
            const lastYear = new Date(today);
            lastYear.setFullYear(today.getFullYear() - 1);
            startDate = lastYear.toISOString().split('T')[0];
            break;
        case 'last-6-months':
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            startDate = sixMonthsAgo.toISOString().split('T')[0];
            break;
        case 'last-3-months':
            const threeMonthsAgo = new Date(today);
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            startDate = threeMonthsAgo.toISOString().split('T')[0];
            break;
        default:
            startDate = '';
            break;
    }
    
    $('#startDate').val(startDate);
    $('#endDate').val(endDate);
}

function updateExportPreview() {
    const previewDiv = $('#exportPreview');
    previewDiv.html('<span class="text-muted">Click Preview to see export details</span>');
    $('#exportBtn').prop('disabled', true);
}

function generateExportPreview() {
    const exportConfig = getExportConfiguration();
    
    // Show loading state
    $('#previewBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm mr-1"></i>Loading...');
    
    // Make preview request (this will be implemented in backend)
    $.ajax({
        url: '/api/settings/export-preview',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(exportConfig),
        success: function(response) {
            displayExportPreview(response);
            $('#exportBtn').prop('disabled', false);
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.detail || 'Failed to generate preview';
            $('#exportPreview').html(`<span class="text-danger">Error: ${error}</span>`);
        },
        complete: function() {
            $('#previewBtn').prop('disabled', false).html('<i class="mdi mdi-eye mr-1"></i>Preview');
        }
    });
}

function displayExportPreview(preview) {
    const previewDiv = $('#exportPreview');
    
    let previewHtml = '<div class="row">';
    previewHtml += `<div class="col-6"><strong>Patients:</strong> ${preview.patients_count}</div>`;
    previewHtml += `<div class="col-6"><strong>Lab Results:</strong> ${preview.lab_results_count}</div>`;
    previewHtml += '</div><div class="row mt-1">';
    previewHtml += `<div class="col-6"><strong>Lab Tests:</strong> ${preview.labs_count}</div>`;
    previewHtml += `<div class="col-6"><strong>Providers:</strong> ${preview.providers_count}</div>`;
    previewHtml += '</div>';
    
    if (preview.include_pdfs) {
        previewHtml += `<div class="row mt-1"><div class="col-12"><strong>PDF Files:</strong> ${preview.pdf_files_count} (ZIP format)</div></div>`;
    }
    
    previewHtml += `<div class="row mt-2"><div class="col-12"><small class="text-muted">Estimated size: ${preview.estimated_size}</small></div></div>`;
    
    previewDiv.html(previewHtml);
}

function getExportConfiguration() {
    const patientSelection = $('#patientSelection').val();
    let patients = ['all'];
    
    if (patientSelection === 'select') {
        patients = $('#specificPatients').val() || [];
    }
    
    let dateRange = null;
    const dateRangeSelection = $('#dateRangeSelection').val();
    
    if (dateRangeSelection !== 'all') {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        if (startDate || endDate) {
            dateRange = {
                start: startDate || null,
                end: endDate || null
            };
        }
    }
    
    return {
        patients: patients,
        include_pdfs: $('#includePdfs').is(':checked'),
        date_range: dateRange,
        format: $('#exportFormat').val()
    };
}

function executeExport() {
    const exportConfig = getExportConfiguration();
    
    // Show loading state
    $('#exportBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm mr-1"></i>Exporting...');
    
    // Use AJAX to download the file
    $.ajax({
        url: '/api/settings/export',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(exportConfig),
        xhrFields: {
            responseType: 'blob' // Important for file downloads
        },
        success: function(blob, status, xhr) {
            // Create a download link
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // Get filename from Content-Disposition header
            const disposition = xhr.getResponseHeader('Content-Disposition');
            let filename = 'mylabvault_export.json';
            if (disposition && disposition.indexOf('filename=') !== -1) {
                filename = disposition.split('filename=')[1].replace(/"/g, '');
            }
            
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Show success message
            const alert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-check mr-2"></i>
                    Export completed successfully. File downloaded: ${filename}
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.detail || 'Failed to export data';
            
            // Show error message
            const alert = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-alert mr-2"></i>
                    Export failed: ${error}
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        },
        complete: function() {
            // Reset button state
            $('#exportBtn').prop('disabled', false).html('<i class="mdi mdi-download mr-1"></i>Export Data');
        }
    });
}

// Data Import Feature Functions
$(document).ready(function() {
    // Initialize import functionality
    initializeImportFeature();
});

function initializeImportFeature() {
    // File input change handler
    $('#importFile').on('change', function() {
        const file = this.files[0];
        if (file) {
            $('.custom-file-label').text(file.name);
            $('#previewImportBtn').prop('disabled', false);
            updateImportWarning();
        } else {
            $('.custom-file-label').text('Choose file...');
            $('#previewImportBtn').prop('disabled', true);
            $('#importBtn').prop('disabled', true);
            $('#importPreview').hide();
            $('#importWarning').hide();
        }
    });
    
    // Import mode radio button handlers
    $('input[name="importMode"]').on('change', function() {
        updateImportWarning();
    });
    
    // Preview import button handler
    $('#previewImportBtn').on('click', function() {
        previewImportFile();
    });
    
    // Import form submission
    $('#importForm').on('submit', function(e) {
        e.preventDefault();
        
        const importMode = $('input[name="importMode"]:checked').val();
        if (importMode === 'replace') {
            // Show confirmation modal for start from scratch
            showStartFromScratchConfirmation();
        } else {
            executeDataImport();
        }
    });
    
    // Confirmation text input handler
    $('#confirmText').on('input', function() {
        const confirmText = $(this).val().trim();
        const isCorrect = confirmText === 'START FROM SCRATCH';
        $('#confirmStartFromScratchBtn').prop('disabled', !isCorrect);
    });
}

function updateImportWarning() {
    const importMode = $('input[name="importMode"]:checked').val();
    const hasFile = $('#importFile')[0].files.length > 0;
    
    if (importMode === 'replace' && hasFile) {
        $('#importWarning').show();
    } else {
        $('#importWarning').hide();
    }
}

function showStartFromScratchConfirmation() {
    // Populate the preview content in the modal
    const previewContent = $('#importPreviewContent').html();
    $('#replacePreviewContent').html(previewContent);
    
    // Reset confirmation input
    $('#confirmText').val('');
    $('#confirmStartFromScratchBtn').prop('disabled', true);
    
    // Show the modal
    $('#startFromScratchModal').modal('show');
}

function executeStartFromScratchImport() {
    // Close the modal
    $('#startFromScratchModal').modal('hide');
    
    // Execute the import with replace mode
    executeDataImport(true);
}

function previewImportFile() {
    const fileInput = $('#importFile')[0];
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to preview');
        return;
    }
    
    // Show loading state
    $('#previewImportBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm mr-1"></i>Loading...');
    
    const formData = new FormData();
    formData.append('import_file', file);
    formData.append('preview_only', 'true');
    
    $.ajax({
        url: '/api/settings/import-preview',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            displayImportPreview(response);
            $('#importBtn').prop('disabled', false);
            $('#importPreview').show();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.detail || 'Failed to preview import file';
            
            const alert = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-alert mr-2"></i>
                    Import preview failed: ${error}
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        },
        complete: function() {
            $('#previewImportBtn').prop('disabled', false).html('<i class="mdi mdi-eye mr-1"></i>Preview Import');
        }
    });
}

function displayImportPreview(preview) {
    const previewDiv = $('#importPreviewContent');
    
    let previewHtml = '<div class="row">';
    previewHtml += `<div class="col-6"><strong>File Type:</strong> ${preview.file_type}</div>`;
    previewHtml += `<div class="col-6"><strong>Export Version:</strong> ${preview.export_version || 'N/A'}</div>`;
    previewHtml += '</div><div class="row mt-1">';
    previewHtml += `<div class="col-6"><strong>Patients:</strong> ${preview.patients_count}</div>`;
    previewHtml += `<div class="col-6"><strong>Lab Results:</strong> ${preview.lab_results_count}</div>`;
    previewHtml += '</div><div class="row mt-1">';
    previewHtml += `<div class="col-6"><strong>Providers:</strong> ${preview.providers_count}</div>`;
    previewHtml += `<div class="col-6"><strong>Lab Tests:</strong> ${preview.labs_count}</div>`;
    previewHtml += '</div>';
    
    if (preview.pdf_files_count > 0) {
        previewHtml += `<div class="row mt-1"><div class="col-12"><strong>PDF Files:</strong> ${preview.pdf_files_count}</div></div>`;
    }
    
    if (preview.conflicts && preview.conflicts.length > 0) {
        previewHtml += '<div class="row mt-2"><div class="col-12">';
        previewHtml += '<small class="text-warning"><strong>Potential Conflicts:</strong></small><br>';
        preview.conflicts.forEach(conflict => {
            previewHtml += `<small class="text-muted">• ${conflict}</small><br>`;
        });
        previewHtml += '</div></div>';
    }
    
    previewHtml += `<div class="row mt-2"><div class="col-12"><small class="text-muted">Total file size: ${preview.file_size}</small></div></div>`;
    
    previewDiv.html(previewHtml);
}

function executeDataImport(isStartFromScratch = false) {
    const fileInput = $('#importFile')[0];
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to import');
        return;
    }
    
    // Show loading state
    $('#importBtn').prop('disabled', true).html('<i class="spinner-border spinner-border-sm mr-1"></i>Importing...');
    
    const formData = new FormData();
    formData.append('import_file', file);
    
    // Determine merge mode - if startFromScratch is true, set merge_data to false
    if (isStartFromScratch) {
        formData.append('merge_data', 'false');
        formData.append('start_from_scratch', 'true');
    } else {
        const importMode = $('input[name="importMode"]:checked').val();
        formData.append('merge_data', importMode === 'merge' ? 'true' : 'false');
        formData.append('start_from_scratch', importMode === 'replace' ? 'true' : 'false');
    }
    
    formData.append('validate_data', $('#validateData').is(':checked'));
    
    $.ajax({
        url: '/api/settings/import',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            // Show success message
            const alert = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-check mr-2"></i>
                    Data import completed successfully! Imported: ${response.imported_records} records, ${response.imported_pdfs || 0} PDF files.
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            
            // Reset form
            $('#importForm')[0].reset();
            $('.custom-file-label').text('Choose file...');
            $('#previewImportBtn').prop('disabled', true);
            $('#importBtn').prop('disabled', true);
            $('#importPreview').hide();
            $('#importWarning').hide();
            
            // Refresh page data if needed
            setTimeout(() => {
                $('.alert').fadeOut();
                // Optionally reload the page to show updated data
                // location.reload();
            }, 5000);
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.detail || 'Failed to import data';
            
            const alert = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="mdi mdi-alert mr-2"></i>
                    Import failed: ${error}
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('.content-header .container-fluid').after(alert);
            setTimeout(() => $('.alert').fadeOut(), 5000);
        },
        complete: function() {
            $('#importBtn').prop('disabled', false).html('<i class="mdi mdi-upload mr-1"></i>Import Data');
        }
    });
}
</script>
{% endblock %}